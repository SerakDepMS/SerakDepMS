name: Update Random Video Daily

on:
  schedule:
    # Se ejecuta cada dÃ­a a medianoche UTC
    - cron: '0 0 * * *'
  # TambiÃ©n se ejecuta manualmente
  workflow_dispatch:
  # Se ejecuta cuando se actualizan los videos
  push:
    paths:
      - 'main/videos/**'

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Generate random number (1-8)
      id: random
      run: |
        # Generar nÃºmero aleatorio entre 1 y 8
        RANDOM_NUM=$(( (RANDOM % 8) + 1 ))
        echo "random_number=$RANDOM_NUM" >> $GITHUB_OUTPUT
        echo "Selected video: video$RANDOM_NUM.mp4"
    
    - name: Update README with random video
      run: |
        RANDOM_NUM=${{ steps.random.outputs.random_number }}
        
        # URL raw para tu estructura especÃ­fica
        VIDEO_URL="https://raw.githubusercontent.com/SerakDepMS/SerakDepMS/main/main/videos/video${RANDOM_NUM}.mp4"
        
        # Crear el cÃ³digo HTML para el video
        cat > video_section.html << EOF
<div align="center">
  <!-- Video animado aleatorio - Actualizado: $(date) -->
  <video src="$VIDEO_URL" width="180" autoplay loop muted playsinline 
         style="border-radius: 15px; border: 3px solid #C8BE25; box-shadow: 0 0 20px rgba(200, 190, 37, 0.3);">
  </video>
</div>
EOF
        
        # Leer el README actual
        README_CONTENT=$(cat README.md)
        
        # Extraer todo excepto la secciÃ³n del video
        # Buscamos desde <!-- VIDEO_START --> hasta <!-- VIDEO_END -->
        UPDATED_CONTENT=$(echo "$README_CONTENT" | awk '
        /<!-- VIDEO_START -->/ {in_video=1; print $0; next}
        /<!-- VIDEO_END -->/ {in_video=0; next}
        !in_video {print $0}
        ')
        
        # Insertar el nuevo video al principio
        NEW_VIDEO=$(cat video_section.html)
        FINAL_CONTENT="<!-- VIDEO_START -->\n$NEW_VIDEO\n<!-- VIDEO_END -->\n\n$UPDATED_CONTENT"
        
        # Escribir el README actualizado
        echo -e "$FINAL_CONTENT" > README.md
    
    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        git diff --quiet && git diff --staged --quiet || git commit -m "ðŸŽ¬ Video aleatorio actualizado: $(date +'%Y-%m-%d %H:%M')"
    
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}